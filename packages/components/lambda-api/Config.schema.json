{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Lambda API Component Configuration",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "handler",
    "deployment",
    "api",
    "logging",
    "monitoring",
    "observability"
  ],
  "properties": {
    "functionName": {
      "type": "string",
      "description": "Explicit name for the Lambda function"
    },
    "handler": {
      "type": "string",
      "description": "Lambda handler entrypoint (e.g. src/api.handler)"
    },
    "runtime": {
      "type": "string",
      "enum": [
        "nodejs20.x",
        "nodejs18.x",
        "python3.11",
        "python3.10",
        "python3.9"
      ],
      "default": "nodejs20.x"
    },
    "architecture": {
      "type": "string",
      "enum": ["x86_64", "arm64"],
      "default": "x86_64"
    },
    "memorySize": {
      "type": "number",
      "minimum": 128,
      "maximum": 10240,
      "default": 512
    },
    "timeoutSeconds": {
      "type": "number",
      "minimum": 1,
      "maximum": 900,
      "default": 30
    },
    "description": {
      "type": "string"
    },
    "environment": {
      "type": "object",
      "default": {},
      "additionalProperties": {
        "type": "string"
      }
    },
    "reservedConcurrency": {
      "type": "number",
      "minimum": 1
    },
    "ephemeralStorageMb": {
      "type": "number",
      "minimum": 512,
      "maximum": 10240,
      "default": 512
    },
    "kmsKeyArn": {
      "type": "string"
    },
    "logging": {
      "type": "object",
      "additionalProperties": false,
      "required": ["logRetentionDays", "logFormat", "systemLogLevel", "applicationLogLevel"],
      "properties": {
        "logRetentionDays": {
          "type": "number",
          "minimum": 1,
          "default": 30
        },
        "logFormat": {
          "type": "string",
          "enum": ["TEXT", "JSON"],
          "default": "JSON"
        },
        "systemLogLevel": {
          "type": "string",
          "enum": ["INFO", "WARN", "ERROR"],
          "default": "INFO"
        },
        "applicationLogLevel": {
          "type": "string",
          "enum": ["DEBUG", "INFO", "WARN", "ERROR"],
          "default": "INFO"
        }
      }
    },
    "tracing": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["Active", "PassThrough"],
          "default": "Active"
        }
      }
    },
    "deployment": {
      "type": "object",
      "additionalProperties": false,
      "required": ["codePath"],
      "properties": {
        "codePath": {
          "type": "string",
          "default": "./src"
        },
        "assetHash": {
          "type": "string"
        },
        "inlineFallbackEnabled": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "vpc": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "vpcId": {
          "type": "string"
        },
        "subnetIds": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "securityGroupIds": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": []
        }
      }
    },
    "observability": {
      "type": "object",
      "additionalProperties": false,
      "required": ["otelEnabled", "otelResourceAttributes"],
      "properties": {
        "otelEnabled": {
          "type": "boolean",
          "default": true
        },
        "otelLayerArn": {
          "type": "string"
        },
        "otelResourceAttributes": {
          "type": "object",
          "default": {},
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "monitoring": {
      "type": "object",
      "additionalProperties": false,
      "required": ["enabled", "alarms"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "alarms": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "lambdaErrors",
            "lambdaThrottles",
            "lambdaDuration",
            "api4xxErrors",
            "api5xxErrors"
          ],
          "properties": {
            "lambdaErrors": { "$ref": "#/definitions/AlarmConfig" },
            "lambdaThrottles": { "$ref": "#/definitions/AlarmConfig" },
            "lambdaDuration": { "$ref": "#/definitions/AlarmConfig" },
            "api4xxErrors": { "$ref": "#/definitions/AlarmConfig" },
            "api5xxErrors": { "$ref": "#/definitions/AlarmConfig" }
          }
        }
      }
    },
    "securityTools": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "falco": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "hardeningProfile": {
      "type": "string",
      "default": "baseline"
    },
    "removalPolicy": {
      "type": "string",
      "enum": ["retain", "destroy"],
      "default": "retain"
    },
    "tags": {
      "type": "object",
      "default": {},
      "additionalProperties": {
        "type": "string"
      }
    },
    "api": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "stageName", "metricsEnabled", "tracingEnabled", "apiKeyRequired", "throttling", "usagePlan", "logging", "cors"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["rest"],
          "default": "rest"
        },
        "name": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "stageName": {
          "type": "string",
          "default": "prod"
        },
        "metricsEnabled": {
          "type": "boolean",
          "default": true
        },
        "tracingEnabled": {
          "type": "boolean",
          "default": true
        },
        "apiKeyRequired": {
          "type": "boolean",
          "default": false
        },
        "throttling": {
          "type": "object",
          "additionalProperties": false,
          "required": ["burstLimit", "rateLimit"],
          "properties": {
            "burstLimit": {
              "type": "number",
              "minimum": 0,
              "default": 100
            },
            "rateLimit": {
              "type": "number",
              "minimum": 0,
              "default": 50
            }
          }
        },
        "usagePlan": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false
            },
            "name": {
              "type": "string"
            },
            "throttle": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "rateLimit": { "type": "number", "minimum": 0 },
                "burstLimit": { "type": "number", "minimum": 0 }
              }
            },
            "quota": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "limit": { "type": "number", "minimum": 1 },
                "period": { "type": "string", "enum": ["DAY", "WEEK", "MONTH"] }
              }
            }
          }
        },
        "logging": {
          "type": "object",
          "additionalProperties": false,
          "required": ["enabled", "retentionDays", "logFormat", "prefix"],
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "retentionDays": { "type": "number", "minimum": 1, "default": 90 },
            "logFormat": { "type": "string", "enum": ["json", "xml"], "default": "json" },
            "logGroupName": { "type": "string" },
            "prefix": { "type": "string", "default": "access/" }
          }
        },
        "cors": {
          "type": "object",
          "additionalProperties": false,
          "required": ["enabled", "allowOrigins", "allowHeaders", "allowMethods", "allowCredentials"],
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "allowOrigins": {
              "type": "array",
              "items": { "type": "string" },
              "default": ["*"]
            },
            "allowHeaders": {
              "type": "array",
              "items": { "type": "string" },
              "default": ["Content-Type", "Authorization", "X-Requested-With"]
            },
            "allowMethods": {
              "type": "array",
              "items": { "type": "string" },
              "default": ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
            },
            "allowCredentials": { "type": "boolean", "default": false }
          }
        }
      }
    }
  },
  "definitions": {
    "AlarmConfig": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "enabled",
        "threshold",
        "evaluationPeriods",
        "periodMinutes",
        "comparisonOperator",
        "treatMissingData",
        "statistic",
        "tags"
      ],
      "properties": {
        "enabled": { "type": "boolean", "default": true },
        "threshold": { "type": "number", "default": 5 },
        "evaluationPeriods": { "type": "number", "minimum": 1, "default": 1 },
        "periodMinutes": { "type": "number", "minimum": 1, "default": 5 },
        "comparisonOperator": {
          "type": "string",
          "enum": ["gt", "gte", "lt", "lte"],
          "default": "gt"
        },
        "treatMissingData": {
          "type": "string",
          "enum": ["breaching", "not-breaching", "ignore", "missing"],
          "default": "not-breaching"
        },
        "statistic": {
          "type": "string",
          "enum": ["Sum", "Average", "Minimum", "Maximum"],
          "default": "Sum"
        },
        "tags": {
          "type": "object",
          "default": {},
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    }
  }
}
